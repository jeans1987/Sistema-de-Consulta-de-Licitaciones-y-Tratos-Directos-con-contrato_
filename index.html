<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Consulta de Licitaciones y Tratos Directos con contrato - Hospital Dr. Carlos Cisternas de Calama</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --success-color: #27ae60;
            --warning-color: #f39c12;
            --danger-color: #e74c3c;
            --light-color: #ecf0f1;
            --dark-color: #34495e;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            overflow: hidden;
        }
        
        header {
            background: var(--primary-color);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        h1 {
            font-size: 2.2rem;
            margin-bottom: 10px;
        }
        
        .subtitle {
            font-size: 1.1rem;
            opacity: 0.9;
            margin-bottom: 10px;
        }
        
        .contact-info {
            margin-top: 10px;
            font-size: 0.9rem;
            opacity: 0.8;
        }
        
        .navigation {
            display: flex;
            background: var(--dark-color);
            padding: 0;
        }
        
        .nav-button {
            flex: 1;
            background: none;
            border: none;
            color: white;
            padding: 20px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            border-bottom: 4px solid transparent;
        }
        
        .nav-button:hover {
            background: rgba(255,255,255,0.1);
        }
        
        .nav-button.active {
            background: var(--secondary-color);
            border-bottom-color: var(--warning-color);
        }
        
        .content-section {
            display: none;
            padding: 30px;
            min-height: 500px;
        }
        
        .content-section.active {
            display: block;
            animation: fadeIn 0.5s ease-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .search-form {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        input[type="text"], select {
            flex: 1;
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s;
        }
        
        input[type="text"]:focus, select:focus {
            border-color: var(--secondary-color);
            outline: none;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
        }
        
        button {
            background: var(--secondary-color);
            color: white;
            border: none;
            padding: 15px 25px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: bold;
            transition: background 0.3s;
        }
        
        button:hover {
            background: #2980b9;
        }
        
        .loading {
            text-align: center;
            padding: 30px;
            display: none;
        }
        
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--secondary-color);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .alert {
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            display: none;
        }
        
        .alert-danger {
            background: rgba(231, 76, 60, 0.1);
            border-left: 4px solid var(--danger-color);
            color: var(--danger-color);
        }
        
        .alert-success {
            background: rgba(39, 174, 96, 0.1);
            border-left: 4px solid var(--success-color);
            color: var(--success-color);
        }
        
        .result-section {
            padding: 25px;
            display: none;
            background: #f8f9fa;
            margin: 20px;
            border-radius: 10px;
        }
        
        .result-section.active {
            display: block;
        }
        
        .result-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #dee2e6;
        }
        
        .result-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--primary-color);
        }
        
        .result-id {
            background: var(--light-color);
            padding: 8px 15px;
            border-radius: 6px;
            font-weight: 600;
            color: var(--dark-color);
        }
        
        .result-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }
        
        .result-item {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            border-left: 4px solid var(--secondary-color);
            transition: transform 0.3s;
        }
        
        .result-item:hover {
            transform: translateY(-2px);
        }
        
        .result-item.alert-danger-item {
            border-left-color: var(--danger-color);
            background: rgba(231, 76, 60, 0.05);
        }
        
        .result-item.alert-warning-item {
            border-left-color: var(--warning-color);
            background: rgba(243, 156, 18, 0.05);
        }
        
        .result-item.alert-success-item {
            border-left-color: var(--success-color);
            background: rgba(39, 174, 96, 0.05);
        }
        
        .result-label {
            font-weight: 600;
            color: #7f8c8d;
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }
        
        .result-value {
            color: var(--dark-color);
            font-size: 1.1rem;
            font-weight: 500;
        }
        
        .status-connected {
            background: rgba(39, 174, 96, 0.1);
            color: var(--success-color);
            padding: 10px 15px;
            border-radius: 6px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .status-disconnected {
            background: rgba(231, 76, 60, 0.1);
            color: var(--danger-color);
            padding: 10px 15px;
            border-radius: 6px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .search-type-badge {
            background: var(--warning-color);
            color: white;
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 0.8rem;
            margin-left: 10px;
        }
        
        .charts-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-top: 20px;
        }
        
        .chart-card {
            background: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        
        .chart-card h3 {
            color: var(--primary-color);
            margin-bottom: 20px;
            text-align: center;
            font-size: 1.2rem;
        }
        
        .chart-wrapper {
            position: relative;
            height: 300px;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }
        
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            text-align: center;
            border-left: 4px solid var(--secondary-color);
        }
        
        .stat-number {
            font-size: 2.5rem;
            font-weight: bold;
            color: var(--primary-color);
            margin-bottom: 10px;
        }
        
        .stat-label {
            color: #7f8c8d;
            font-size: 1rem;
            font-weight: 600;
        }
        
        .analista-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        
        .analista-table th {
            background: var(--primary-color);
            color: white;
            padding: 15px;
            text-align: left;
            font-weight: 600;
        }
        
        .analista-table td {
            padding: 12px 15px;
            border-bottom: 1px solid #eee;
        }
        
        .analista-table tr:hover {
            background: #f8f9fa;
        }
        
        .analista-table tr:last-child td {
            border-bottom: none;
        }
        
        .alertas-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        
        .alertas-table th {
            background: var(--danger-color);
            color: white;
            padding: 15px;
            text-align: left;
            font-weight: 600;
        }
        
        .alertas-table td {
            padding: 12px 15px;
            border-bottom: 1px solid #eee;
        }
        
        .alertas-table tr:hover {
            background: #f8f9fa;
        }
        
        .alertas-table tr:last-child td {
            border-bottom: none;
        }
        
        .alerta-caducada {
            background: rgba(231, 76, 60, 0.05);
        }
        
        .alerta-caducada td:first-child {
            border-left: 4px solid var(--danger-color);
        }
        
        .alerta-baja {
            background: rgba(243, 156, 18, 0.05);
        }
        
        .alerta-baja td:first-child {
            border-left: 4px solid var(--warning-color);
        }
        
        .contador-alertas {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .contador-item {
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            text-align: center;
            flex: 1;
            min-width: 150px;
        }
        
        .contador-numero {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .contador-caducada {
            color: var(--danger-color);
        }
        
        .contador-baja {
            color: var(--warning-color);
        }
        
        .contador-vigente {
            color: var(--success-color);
        }
        
        .contador-gestion {
            color: var(--secondary-color);
        }
        
        .contador-label {
            color: #7f8c8d;
            font-size: 0.9rem;
        }

        /* Estilos para filtros */
        .filtros-container {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            border: 2px solid #e9ecef;
        }
        
        .filtros-header {
            display: flex;
            justify-content: between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .filtros-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--primary-color);
        }
        
        .filtros-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .filtro-group {
            display: flex;
            flex-direction: column;
        }
        
        .filtro-label {
            font-weight: 600;
            color: #495057;
            margin-bottom: 5px;
            font-size: 0.9rem;
        }
        
        .filtro-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }
        
        .btn-filtrar {
            background: var(--success-color);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
        }
        
        .btn-filtrar:hover {
            background: #229954;
        }
        
        .btn-limpiar {
            background: var(--warning-color);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
        }
        
        .btn-limpiar:hover {
            background: #e67e22;
        }
        
        .resultados-info {
            background: var(--light-color);
            padding: 10px 15px;
            border-radius: 6px;
            margin: 10px 0;
            font-weight: 600;
            color: var(--dark-color);
        }

        /* Estilos para mostrar registros adicionales */
        .additional-records {
            margin-top: 30px;
            display: none;
        }
        
        .additional-records.active {
            display: block;
        }
        
        .additional-records-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #dee2e6;
        }
        
        .additional-records-title {
            font-size: 1.3rem;
            font-weight: 600;
            color: var(--primary-color);
        }
        
        .additional-records-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        
        .additional-records-table th {
            background: var(--warning-color);
            color: white;
            padding: 15px;
            text-align: left;
            font-weight: 600;
        }
        
        .additional-records-table td {
            padding: 12px 15px;
            border-bottom: 1px solid #eee;
        }
        
        .additional-records-table tr:hover {
            background: #f8f9fa;
        }
        
        .additional-records-table tr:last-child td {
            border-bottom: none;
        }
        
        .toggle-records-btn {
            background: var(--warning-color);
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: bold;
            transition: background 0.3s;
        }
        
        .toggle-records-btn:hover {
            background: #e67e22;
        }
        
        /* Estilos para diagn√≥stico */
        .diagnostico-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            border-left: 4px solid var(--warning-color);
        }
        
        .diagnostico-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        
        .diagnostico-resultado {
            background: white;
            padding: 15px;
            border-radius: 8px;
            font-family: monospace;
            font-size: 0.9rem;
            max-height: 300px;
            overflow-y: auto;
            display: none;
            border: 1px solid #ddd;
        }
        
        .diagnostico-btn {
            background: var(--warning-color);
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: bold;
        }
        
        .diagnostico-btn:hover {
            background: #e67e22;
        }
        
        .datos-prueba-btn {
            background: var(--success-color);
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: bold;
        }
        
        .datos-prueba-btn:hover {
            background: #229954;
        }
        
        /* Estilo para tablitas tipo Excel */
        .excel-table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border: 2px solid #e0e0e0;
        }
        
        .excel-table th {
            background: #2e7d32;
            color: white;
            padding: 12px 15px;
            text-align: left;
            font-weight: 600;
            border-bottom: 2px solid #1b5e20;
        }
        
        .excel-table td {
            padding: 10px 15px;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .excel-table tr:last-child td {
            border-bottom: none;
        }
        
        .excel-table tr:hover {
            background: #f5f5f5;
        }
        
        .excel-table .header-row {
            background: #4caf50;
            color: white;
            font-weight: bold;
        }
        
        @media (max-width: 768px) {
            .navigation {
                flex-direction: column;
            }
            
            .nav-button {
                text-align: center;
            }
            
            .search-form {
                flex-direction: column;
            }
            
            .result-header {
                flex-direction: column;
                gap: 15px;
                align-items: flex-start;
            }
            
            .result-grid {
                grid-template-columns: 1fr;
            }
            
            h1 {
                font-size: 1.8rem;
            }
            
            .charts-container {
                grid-template-columns: 1fr;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .contador-alertas {
                flex-direction: column;
            }
            
            .additional-records-header {
                flex-direction: column;
                gap: 15px;
                align-items: flex-start;
            }
            
            .diagnostico-buttons {
                flex-direction: column;
            }
            
            .filtros-grid {
                grid-template-columns: 1fr;
            }
            
            .filtro-actions {
                justify-content: stretch;
            }
            
            .btn-filtrar, .btn-limpiar {
                flex: 1;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Sistema de Consulta de Licitaciones y Tratos Directos con contrato</h1>
            <p class="subtitle">Hospital Dr. Carlos Cisternas de Calama</p>
            <p class="subtitle">Consulta informaci√≥n detallada por ID de Licitaci√≥n o Trato Directo con contrato</p>
            <p class="contact-info">Si necesitas una consulta espec√≠fica, por favor comunicarse con jeans.munoz.d@redsalud.gob.cl</p>
        </header>
        
        <nav class="navigation">
            <button class="nav-button active" data-section="resumen">Resumen por Analista</button>
            <button class="nav-button" data-section="licitaciones">B√∫squeda por Licitaci√≥n</button>
            <button class="nav-button" data-section="tratos-directos">B√∫squeda por Trato Directo con contrato</button>
        </nav>
        
        <!-- Secci√≥n Resumen por Analista -->
        <section id="resumen" class="content-section active">
            <h2>Resumen de Licitaciones y Tratos Directos con contrato Vigente por Analista</h2>
            
            <div class="status-connected" id="statusResumen">
                <span>‚úÖ</span>
                <span>Sistema conectado correctamente a Google Sheets</span>
            </div>

            <!-- Secci√≥n de diagn√≥stico -->
            <div class="diagnostico-section">
                <h3>üîß Diagn√≥stico del Sistema</h3>
                <div class="diagnostico-buttons">
                    <button class="diagnostico-btn" id="btnDiagnostico">Ejecutar Diagn√≥stico</button>
                    <button class="datos-prueba-btn" id="btnForzarDatos">Cargar Datos de Prueba</button>
                    <button class="diagnostico-btn" id="btnProbarConexion">Probar Conexi√≥n</button>
                </div>
                <div class="diagnostico-resultado" id="diagnosticoResultado"></div>
            </div>
            
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-number" id="totalAnalistas">0</div>
                    <div class="stat-label">Total de Analistas</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="totalLicitaciones">0</div>
                    <div class="stat-label">Total Licitaciones</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="totalTratosDirectos">0</div>
                    <div class="stat-label">Total Tratos Directos con contrato</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="totalGeneral">0</div>
                    <div class="stat-label">Total General</div>
                </div>
            </div>
            
            <div class="charts-container">
                <div class="chart-card">
                    <h3>Distribuci√≥n por Analistas de Licitaciones y Tratos Directos vigentes con contrato</h3>
                    <div class="chart-wrapper">
                        <canvas id="chartAnalistas"></canvas>
                    </div>
                </div>
                
                <div class="chart-card">
                    <h3>Porcentaje de Licitaciones vs Tratos Directos Vigentes con contrato</h3>
                    <div class="chart-wrapper">
                        <canvas id="chartComparacion"></canvas>
                    </div>
                </div>
            </div>

            <!-- NUEVOS GR√ÅFICOS DE MONTOS SEPARADOS -->
            <div class="charts-container" style="margin-top: 30px;">
                <div class="chart-card">
                    <h3>Montos de Licitaciones Vigentes</h3>
                    <div class="chart-wrapper">
                        <canvas id="chartMontosLicitaciones"></canvas>
                    </div>
                </div>
                
                <div class="chart-card">
                    <h3>Montos de Tratos Directos Vigentes con contrato</h3>
                    <div class="chart-wrapper">
                        <canvas id="chartMontosTratosDirectos"></canvas>
                    </div>
                </div>
            </div>
            
            <div class="chart-card">
                <h3>Detalle de Administraci√≥n por Analista de Licitaciones y Tratos Directos con contrato</h3>
                <table class="analista-table">
                    <thead>
                        <tr>
                            <th>Analista</th>
                            <th>Licitaciones</th>
                            <th>Tratos Directos</th>
                            <th>Total</th>
                            <th>% del Total</th>
                        </tr>
                    </thead>
                    <tbody id="tablaAnalistas">
                        <!-- Los datos se cargar√°n din√°micamente -->
                    </tbody>
                </table>
            </div>

            <!-- Secci√≥n para licitaciones caducadas CON FILTROS -->
            <div class="chart-card" style="margin-top: 30px;">
                <h3>Licitaciones con Alerta Caducada o Menor a 120 d√≠as</h3>
                
                <div class="contador-alertas">
                    <div class="contador-item">
                        <div class="contador-numero contador-caducada" id="contadorLicitacionesCaducadas">0</div>
                        <div class="contador-label">Licitaciones Caducadas</div>
                    </div>
                    <div class="contador-item">
                        <div class="contador-numero contador-baja" id="contadorLicitacionesAlerta">0</div>
                        <div class="contador-label">Licitaciones con Alerta (‚â§120 d√≠as)</div>
                    </div>
                </div>

                <!-- Filtros para Licitaciones -->
                <div class="filtros-container" id="filtrosLicitaciones">
                    <div class="filtros-header">
                        <div class="filtros-title">üîç Filtros de B√∫squeda</div>
                    </div>
                    <div class="filtros-grid">
                        <div class="filtro-group">
                            <label class="filtro-label">Analista</label>
                            <select id="filtroAnalistaLicitaciones">
                                <option value="">Todos los analistas</option>
                            </select>
                        </div>
                        <div class="filtro-group">
                            <label class="filtro-label">A√±o</label>
                            <select id="filtroAnoLicitaciones">
                                <option value="">Todos los a√±os</option>
                            </select>
                        </div>
                        <div class="filtro-group">
                            <label class="filtro-label">Proveedor</label>
                            <input type="text" id="filtroProveedorLicitaciones" placeholder="Buscar proveedor...">
                        </div>
                        <div class="filtro-group">
                            <label class="filtro-label">Estado Alerta</label>
                            <select id="filtroEstadoLicitaciones">
                                <option value="">Todos los estados</option>
                                <option value="CADUCADA">CADUCADA</option>
                                <option value="ALERTA">‚â§120 d√≠as</option>
                            </select>
                        </div>
                    </div>
                    <div class="filtro-actions">
                        <button class="btn-filtrar" onclick="aplicarFiltrosLicitaciones()">Aplicar Filtros</button>
                        <button class="btn-limpiar" onclick="limpiarFiltrosLicitaciones()">Limpiar Filtros</button>
                    </div>
                    <div class="resultados-info" id="infoResultadosLicitaciones">
                        Mostrando todos los resultados
                    </div>
                </div>
                
                <table class="alertas-table">
                    <thead>
                        <tr>
                            <th>A√±o</th>
                            <th>Proveedor</th>
                            <th>Alerta Contrato</th>
                            <th>Monto Adjudicado</th>
                            <th>Saldo Adjudicado</th>
                            <th>ID Licitacion</th>
                            <th>Nombre Licitacion</th>
                            <th>Nombre de Analista</th>
                            <th>Observacion</th>
                        </tr>
                    </thead>
                    <tbody id="tablaAlertasLicitaciones">
                        <!-- Los datos se cargar√°n din√°micamente -->
                    </tbody>
                </table>
            </div>

            <!-- Secci√≥n para tratos directos caducados CON FILTROS -->
            <div class="chart-card" style="margin-top: 30px;">
                <h3>Tratos Directos con contrato - Alertas Caducadas o ‚â§120 d√≠as</h3>
                
                <div class="contador-alertas">
                    <div class="contador-item">
                        <div class="contador-numero contador-caducada" id="contadorTratosCaducados">0</div>
                        <div class="contador-label">Tratos Directos Caducados</div>
                    </div>
                    <div class="contador-item">
                        <div class="contador-numero contador-baja" id="contadorTratosAlerta">0</div>
                        <div class="contador-label">Tratos Directos con Alerta (‚â§120 d√≠as)</div>
                    </div>
                </div>

                <!-- Filtros para Tratos Directos -->
                <div class="filtros-container" id="filtrosTratosDirectos">
                    <div class="filtros-header">
                        <div class="filtros-title">üîç Filtros de B√∫squeda</div>
                    </div>
                    <div class="filtros-grid">
                        <div class="filtro-group">
                            <label class="filtro-label">Analista</label>
                            <select id="filtroAnalistaTratos">
                                <option value="">Todos los analistas</option>
                            </select>
                        </div>
                        <div class="filtro-group">
                            <label class="filtro-label">A√±o</label>
                            <select id="filtroAnoTratos">
                                <option value="">Todos los a√±os</option>
                            </select>
                        </div>
                        <div class="filtro-group">
                            <label class="filtro-label">Proveedor</label>
                            <input type="text" id="filtroProveedorTratos" placeholder="Buscar proveedor...">
                        </div>
                    </div>
                    <div class="filtro-actions">
                        <button class="btn-filtrar" onclick="aplicarFiltrosTratosDirectos()">Aplicar Filtros</button>
                        <button class="btn-limpiar" onclick="limpiarFiltrosTratosDirectos()">Limpiar Filtros</button>
                    </div>
                    <div class="resultados-info" id="infoResultadosTratos">
                        Mostrando todos los resultados
                    </div>
                </div>
                
                <table class="alertas-table">
                    <thead>
                        <tr>
                            <th>A√±o</th>
                            <th>N√∫mero OC</th>
                            <th>Proveedor</th>
                            <th>Termino Contrato</th>
                            <th>Alerta Contrato</th>
                            <th>Monto Adjudicado</th>
                            <th>Saldo</th>
                            <th>TD</th>
                            <th>Nombre de Analista</th>
                            <th>Observacion</th>
                        </tr>
                    </thead>
                    <tbody id="tablaAlertasTratosDirectos">
                        <!-- Los datos se cargar√°n din√°micamente -->
                    </tbody>
                </table>
            </div>
        </section>
        
        <!-- Secci√≥n B√∫squeda por Licitaci√≥n -->
        <section id="licitaciones" class="content-section">
            <h2>B√∫squeda por Licitaci√≥n</h2>
            
            <div class="status-connected" id="statusLicitaciones">
                <span>‚úÖ</span>
                <span>Sistema conectado correctamente a Google Sheets</span>
            </div>
            
            <form class="search-form" id="searchFormLicitacion">
                <input type="text" id="searchInputLicitacion" placeholder="Ingresa el ID de licitaci√≥n (ej: 2215-69-LQ23)" required>
                <button type="submit">Buscar Licitaci√≥n</button>
            </form>
            
            <div class="loading" id="loadingIndicatorLicitacion">
                <div class="spinner"></div>
                <p>Buscando informaci√≥n en la base de datos...</p>
            </div>
            
            <div class="alert alert-danger" id="errorAlertLicitacion">
                <span id="errorMessageLicitacion"></span>
            </div>
            
            <div class="result-section" id="resultSectionLicitacion">
                <div class="result-header">
                    <h2 class="result-title" id="resultMainTitleLicitacion">
                        Informaci√≥n de la Licitaci√≥n
                        <span class="search-type-badge">Licitaci√≥n</span>
                    </h2>
                    <div class="result-id" id="resultIdLicitacion">ID: </div>
                </div>
                
                <div id="resultGridLicitacion">
                    <!-- Aqu√≠ se mostrar√°n las tablitas tipo Excel -->
                </div>
            </div>
        </section>
        
        <!-- Secci√≥n B√∫squeda por Trato Directo -->
        <section id="tratos-directos" class="content-section">
            <h2>B√∫squeda por Trato Directo con contrato</h2>
            
            <div class="status-connected" id="statusTratosDirectos">
                <span>‚úÖ</span>
                <span>Sistema conectado correctamente a Google Sheets</span>
            </div>
            
            <form class="search-form" id="searchFormTratoDirecto">
                <input type="text" id="searchInputTratoDirecto" placeholder="Ingresa el RES TD (ej: 2568, 1401, 3327)" required>
                <button type="submit">Buscar Trato Directo</button>
            </form>
            
            <div class="loading" id="loadingIndicatorTratoDirecto">
                <div class="spinner"></div>
                <p>Buscando informaci√≥n en la base de datos...</p>
            </div>
            
            <div class="alert alert-danger" id="errorAlertTratoDirecto">
                <span id="errorMessageTratoDirecto"></span>
            </div>
            
            <div class="result-section" id="resultSectionTratoDirecto">
                <div class="result-header">
                    <h2 class="result-title" id="resultMainTitleTratoDirecto">
                        Informaci√≥n del Trato Directo
                        <span class="search-type-badge">Trato Directo</span>
                    </h2>
                    <div class="result-id" id="resultIdTratoDirecto">ID: </div>
                </div>
                
                <div id="resultGridTratoDirecto">
                    <!-- Aqu√≠ se mostrar√°n las tablitas tipo Excel -->
                </div>
            </div>
        </section>
    </div>

    <script>
        // ‚úÖ NUEVA URL DEL SCRIPT CORREGIDO
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzfjAAcNo9xtVp_IcnXfCRF-Lashx8DG-JyaUE6SfRDRyA4zEsbursNoIl2EXMmm3Tpbw/exec';
        
        // Variables globales
        let datosGlobales = {};
        let chartInstances = {};
        
        // Variables para filtros
        let datosLicitacionesFiltro = [];
        let datosTratosDirectosFiltro = [];
        let filtrosAplicadosLicitaciones = false;
        let filtrosAplicadosTratosDirectos = false;

        // Inicializar la aplicaci√≥n cuando el DOM est√© listo
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ Aplicaci√≥n iniciada con URL:', SCRIPT_URL);
            inicializarNavegacion();
            inicializarDiagnostico();
            cargarDatosIniciales();
            inicializarBusquedas();
        });

        // Funci√≥n para inicializar diagn√≥stico
        function inicializarDiagnostico() {
            document.getElementById('btnDiagnostico').addEventListener('click', ejecutarDiagnostico);
            document.getElementById('btnForzarDatos').addEventListener('click', cargarDatosPrueba);
            document.getElementById('btnProbarConexion').addEventListener('click', probarConexion);
        }

        // Funci√≥n para probar conexi√≥n simple
        async function probarConexion() {
            const resultado = document.getElementById('diagnosticoResultado');
            resultado.style.display = 'block';
            resultado.innerHTML = '<div style="color: var(--warning-color);">üîÑ Probando conexi√≥n...</div>';

            try {
                const response = await fetch(SCRIPT_URL + '?action=getResumenGeneral');
                if (!response.ok) {
                    throw new Error(`Error HTTP: ${response.status}`);
                }
                
                const data = await response.json();
                resultado.innerHTML = `<div style="color: var(--success-color);">‚úÖ Conexi√≥n exitosa! El servidor respondi√≥ correctamente.</div>`;
                
            } catch (error) {
                resultado.innerHTML = `<div style="color: var(--danger-color);">‚ùå Error de conexi√≥n: ${error.message}</div>`;
            }
        }

        // Funci√≥n de diagn√≥stico completo
        async function ejecutarDiagnostico() {
            const resultado = document.getElementById('diagnosticoResultado');
            resultado.style.display = 'block';
            resultado.innerHTML = '<div class="loading"><div class="spinner"></div><p>Ejecutando diagn√≥stico completo...</p></div>';

            let mensajes = [];
            
            try {
                // 1. Verificar conexi√≥n b√°sica
                mensajes.push('üîç Probando conexi√≥n con Google Apps Script...');
                const testResponse = await fetch(SCRIPT_URL + '?action=getResumenGeneral');
                
                if (!testResponse.ok) {
                    throw new Error(`Error HTTP: ${testResponse.status}`);
                }
                
                const testData = await testResponse.json();
                mensajes.push('‚úÖ Conexi√≥n exitosa con Google Apps Script');
                mensajes.push(`üìä Estado: ${testData.success ? '√âXITO' : 'ERROR'}`);

                // 2. Verificar estructura de datos
                if (testData.success && testData.datos) {
                    mensajes.push('‚úÖ Estructura de datos correcta');
                    
                    if (testData.datos.totales) {
                        mensajes.push(`üìà Totales: ${testData.datos.totales.analistas} analistas, ${testData.datos.totales.licitaciones} licitaciones, ${testData.datos.totales.tratosDirectos} tratos directos`);
                    }
                    
                    if (testData.datos.analistas && Array.isArray(testData.datos.analistas)) {
                        mensajes.push(`üë• Analistas encontrados: ${testData.datos.analistas.length}`);
                    }
                    
                    if (testData.datos.montos) {
                        mensajes.push(`üí∞ Montos: Licitaciones $${testData.datos.montos.licitaciones?.montoAdjudicado || 0}, Tratos $${testData.datos.montos.tratosDirectos?.montoAdjudicado || 0}`);
                    }
                } else {
                    mensajes.push('‚ùå Estructura de datos incorrecta');
                    if (testData.error) {
                        mensajes.push(`‚ö†Ô∏è Error: ${testData.error}`);
                    }
                }

                // 3. Probar b√∫squeda
                mensajes.push('üîé Probando b√∫squeda de licitaci√≥n...');
                const searchResponse = await fetch(SCRIPT_URL + '?id=2215-69-LQ23&tipo=licitacion');
                const searchData = await searchResponse.json();
                mensajes.push(`üîç B√∫squeda: ${searchData.success ? 'FUNCIONA' : 'FALLA'} - ${searchData.data ? searchData.data.length + ' resultados' : searchData.error}`);

            } catch (error) {
                mensajes.push(`‚ùå Error de conexi√≥n: ${error.message}`);
                mensajes.push('üîß Posibles soluciones:');
                mensajes.push('1. Verifica que la URL del script sea correcta');
                mensajes.push('2. Aseg√∫rate de que el script est√© desplegado como "Cualquier usuario"');
                mensajes.push('3. Revisa la consola del navegador (F12) para m√°s detalles');
            }

            // Mostrar resultados del diagn√≥stico
            resultado.innerHTML = '<h4>Resultado del Diagn√≥stico:</h4>' + 
                mensajes.map(msg => `<div style="margin: 5px 0; padding: 8px; background: #f8f9fa; border-radius: 4px;">${msg}</div>`).join('');
        }

        // Funci√≥n para cargar datos de prueba
        function cargarDatosPrueba() {
            console.log('üìä Cargando datos de prueba...');
            
            // Datos de ejemplo con 9 analistas
            const datosPrueba = {
                totales: {
                    analistas: 9,
                    licitaciones: 85,
                    tratosDirectos: 16,
                    general: 101
                },
                analistas: [
                    { analista: "Ximena Cortes Campana", licitacionesVigentes: 16, tratosDirectos: 6 },
                    { analista: "Marianjeles Araya Garcia", licitacionesVigentes: 2, tratosDirectos: 0 },
                    { analista: "Claudia Araya Perez", licitacionesVigentes: 18, tratosDirectos: 2 },
                    { analista: "Hilda Carrasco Carrasco", licitacionesVigentes: 2, tratosDirectos: 5 },
                    { analista: "Ingrid Zavala Contreras", licitacionesVigentes: 22, tratosDirectos: 1 },
                    { analista: "Eleazar Ramirez Yanez", licitacionesVigentes: 11, tratosDirectos: 0 },
                    { analista: "Alexandra Berna Berna", licitacionesVigentes: 4, tratosDirectos: 1 },
                    { analista: "Alexandra Castro Quispe", licitacionesVigentes: 9, tratosDirectos: 1 },
                    { analista: "Wilson Aracena Cortes", licitacionesVigentes: 1, tratosDirectos: 0 }
                ],
                montos: {
                    licitaciones: {
                        montoAdjudicado: 7200394194,
                        saldoAdjudicado: 2318204515
                    },
                    tratosDirectos: {
                        montoAdjudicado: 2498375891,
                        saldoAdjudicado: 1482276657
                    }
                }
            };

            datosGlobales = { datos: datosPrueba };
            actualizarResumenGeneral();
            
            // Mostrar mensaje de √©xito
            const resultado = document.getElementById('diagnosticoResultado');
            resultado.style.display = 'block';
            resultado.innerHTML = '<div style="color: var(--success-color); padding: 10px; background: rgba(39, 174, 96, 0.1); border-radius: 6px;">‚úÖ Datos de prueba cargados correctamente. El sistema deber√≠a funcionar ahora.</div>';
        }

        // Funci√≥n para manejar la navegaci√≥n entre secciones
        function inicializarNavegacion() {
            const navButtons = document.querySelectorAll('.nav-button');
            const contentSections = document.querySelectorAll('.content-section');
            
            navButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const targetSection = this.dataset.section;
                    
                    // Remover clase active de todos los botones y secciones
                    navButtons.forEach(btn => btn.classList.remove('active'));
                    contentSections.forEach(section => section.classList.remove('active'));
                    
                    // Agregar clase active al bot√≥n y secci√≥n seleccionados
                    this.classList.add('active');
                    document.getElementById(targetSection).classList.add('active');
                });
            });
        }

        // Funci√≥n para cargar datos iniciales
        async function cargarDatosIniciales() {
            try {
                console.log('üîÑ Cargando datos desde:', SCRIPT_URL + '?action=getResumenGeneral');
                const response = await fetch(`${SCRIPT_URL}?action=getResumenGeneral`);
                
                if (!response.ok) {
                    throw new Error(`Error HTTP: ${response.status}`);
                }
                
                const data = await response.json();
                console.log('üìä Datos recibidos:', data);
                
                if (data.success) {
                    datosGlobales = data;
                    actualizarResumenGeneral();
                    await cargarContratosCaducados();
                    actualizarEstadoConexion(true);
                    
                    // Mostrar √©xito en diagn√≥stico
                    const resultado = document.getElementById('diagnosticoResultado');
                    resultado.style.display = 'block';
                    resultado.innerHTML = '<div style="color: var(--success-color); padding: 10px; background: rgba(39, 174, 96, 0.1); border-radius: 6px;">‚úÖ Datos cargados correctamente desde Google Sheets</div>';
                } else {
                    throw new Error(data.error || 'Error en la respuesta del servidor');
                }
            } catch (error) {
                console.error('‚ùå Error cargando datos:', error);
                mostrarError('Error conectando con el servidor: ' + error.message, 'general');
                actualizarEstadoConexion(false);
                
                // Mostrar error en diagn√≥stico
                const resultado = document.getElementById('diagnosticoResultado');
                resultado.style.display = 'block';
                resultado.innerHTML = `
                    <div style="color: var(--danger-color); padding: 15px; background: rgba(231, 76, 60, 0.1); border-radius: 6px;">
                        <strong>Error de conexi√≥n:</strong> ${error.message}
                        <br><br>
                        <strong>Usa el bot√≥n "Cargar Datos de Prueba" para continuar probando el sistema.</strong>
                    </div>
                `;
            }
        }

        // Funci√≥n para actualizar estado de conexi√≥n
        function actualizarEstadoConexion(conectado) {
            const statusElements = document.querySelectorAll('.status-connected');
            statusElements.forEach(element => {
                if (conectado) {
                    element.innerHTML = '<span>‚úÖ</span><span>Sistema conectado correctamente a Google Sheets</span>';
                    element.className = 'status-connected';
                } else {
                    element.innerHTML = '<span>‚ùå</span><span>Error de conexi√≥n con Google Sheets</span>';
                    element.className = 'status-disconnected';
                }
            });
        }

        // Funci√≥n para actualizar resumen con datos generales
        function actualizarResumenGeneral() {
            if (!datosGlobales.datos) {
                console.error('No hay datos disponibles:', datosGlobales);
                mostrarError('No se recibieron datos del servidor', 'general');
                return;
            }

            const datos = datosGlobales.datos;
            console.log('üìà Actualizando resumen con datos:', datos);
            
            // Actualizar estad√≠sticas principales
            document.getElementById('totalAnalistas').textContent = datos.totales?.analistas || 0;
            document.getElementById('totalLicitaciones').textContent = datos.totales?.licitaciones || 0;
            document.getElementById('totalTratosDirectos').textContent = datos.totales?.tratosDirectos || 0;
            document.getElementById('totalGeneral').textContent = datos.totales?.general || 0;
            
            // Crear gr√°ficos
            if (datos.analistas && Array.isArray(datos.analistas)) {
                crearGraficoAnalistas(datos.analistas);
                crearGraficoComparacion(datos.totales?.licitaciones || 0, datos.totales?.tratosDirectos || 0);
                actualizarTablaAnalistas(datos.analistas, datos.totales?.general || 0);
            }
            
            if (datos.montos) {
                crearGraficosMontos(datos.montos);
            }
        }

        // Funci√≥n para crear gr√°fico de analistas
        function crearGraficoAnalistas(analistas) {
            // Destruir gr√°fico existente si lo hay
            if (chartInstances.analistas) {
                chartInstances.analistas.destroy();
            }

            // Preparar datos para el gr√°fico
            const nombres = analistas.map(a => {
                // Acortar nombres largos para mejor visualizaci√≥n
                const nombreCompleto = a.analista || '';
                const partes = nombreCompleto.split(' ');
                return partes.length > 2 ? `${partes[0]} ${partes[2] || partes[1]}` : nombreCompleto;
            });
            const licitaciones = analistas.map(a => a.licitacionesVigentes || 0);
            const tratosDirectos = analistas.map(a => a.tratosDirectos || 0);

            // Gr√°fico de barras agrupadas
            const ctxAnalistas = document.getElementById('chartAnalistas').getContext('2d');
            chartInstances.analistas = new Chart(ctxAnalistas, {
                type: 'bar',
                data: {
                    labels: nombres,
                    datasets: [
                        {
                            label: 'Licitaciones',
                            data: licitaciones,
                            backgroundColor: '#3498db',
                            borderColor: '#2980b9',
                            borderWidth: 1
                        },
                        {
                            label: 'Tratos Directos con contrato',
                            data: tratosDirectos,
                            backgroundColor: '#e74c3c',
                            borderColor: '#c0392b',
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Distribuci√≥n por Analista'
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Analistas'
                            }
                        },
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Cantidad'
                            }
                        }
                    }
                }
            });
        }

        // Funci√≥n para crear gr√°fico de comparaci√≥n
        function crearGraficoComparacion(licitaciones, tratosDirectos) {
            // Destruir gr√°fico existente si lo hay
            if (chartInstances.comparacion) {
                chartInstances.comparacion.destroy();
            }

            const total = licitaciones + tratosDirectos;
            const porcentajeLicitaciones = total > 0 ? Math.round((licitaciones / total) * 100) : 0;
            const porcentajeTratos = total > 0 ? Math.round((tratosDirectos / total) * 100) : 0;

            // Gr√°fico de torta
            const ctxComparacion = document.getElementById('chartComparacion').getContext('2d');
            chartInstances.comparacion = new Chart(ctxComparacion, {
                type: 'pie',
                data: {
                    labels: [
                        `Licitaciones (${porcentajeLicitaciones}%)`,
                        `Tratos Directos con contrato (${porcentajeTratos}%)`
                    ],
                    datasets: [{
                        data: [licitaciones, tratosDirectos],
                        backgroundColor: ['#3498db', '#e74c3c'],
                        borderColor: ['#2980b9', '#c0392b'],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Distribuci√≥n General'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.raw || 0;
                                    return `${label}: ${value} contratos`;
                                }
                            }
                        },
                        legend: {
                            position: 'bottom',
                            labels: {
                                generateLabels: function(chart) {
                                    const data = chart.data;
                                    if (data.labels.length && data.datasets.length) {
                                        return data.labels.map((label, i) => {
                                            const value = data.datasets[0].data[i];
                                            return {
                                                text: label,
                                                fillStyle: data.datasets[0].backgroundColor[i],
                                                strokeStyle: data.datasets[0].borderColor[i],
                                                lineWidth: 1,
                                                hidden: false,
                                                index: i
                                            };
                                        });
                                    }
                                    return [];
                                }
                            }
                        }
                    }
                }
            });
        }

        // Funci√≥n para crear gr√°ficos de montos separados
        function crearGraficosMontos(montos) {
            // Destruir gr√°ficos existentes si los hay
            if (chartInstances.montosLicitaciones) {
                chartInstances.montosLicitaciones.destroy();
            }
            if (chartInstances.montosTratosDirectos) {
                chartInstances.montosTratosDirectos.destroy();
            }

            // Gr√°fico de √Årea para Licitaciones (Azul)
            const ctxLicitaciones = document.getElementById('chartMontosLicitaciones').getContext('2d');
            chartInstances.montosLicitaciones = new Chart(ctxLicitaciones, {
                type: 'line',
                data: {
                    labels: ['Monto Adjudicado', 'Saldo Adjudicado'],
                    datasets: [{
                        label: 'Licitaciones',
                        data: [
                            montos.licitaciones.montoAdjudicado || 0,
                            montos.licitaciones.saldoAdjudicado || 0
                        ],
                        backgroundColor: 'rgba(52, 152, 219, 0.2)',
                        borderColor: '#3498db',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Montos de Licitaciones Vigentes'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.dataset.label || '';
                                    const value = context.raw || 0;
                                    return `${label}: $${formatearNumero(value)}`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Monto ($)'
                            },
                            ticks: {
                                callback: function(value) {
                                    return '$' + formatearNumero(value);
                                }
                            }
                        }
                    }
                }
            });

            // Gr√°fico de √Årea para Tratos Directos (Verde)
            const ctxTratosDirectos = document.getElementById('chartMontosTratosDirectos').getContext('2d');
            chartInstances.montosTratosDirectos = new Chart(ctxTratosDirectos, {
                type: 'line',
                data: {
                    labels: ['Monto Adjudicado', 'Saldo'],
                    datasets: [{
                        label: 'Tratos Directos con contrato',
                        data: [
                            montos.tratosDirectos.montoAdjudicado || 0,
                            montos.tratosDirectos.saldoAdjudicado || 0
                        ],
                        backgroundColor: 'rgba(46, 204, 113, 0.2)',
                        borderColor: '#2ecc71',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Montos de Tratos Directos Vigentes con contrato'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.dataset.label || '';
                                    const value = context.raw || 0;
                                    return `${label}: $${formatearNumero(value)}`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Monto ($)'
                            },
                            ticks: {
                                callback: function(value) {
                                    return '$' + formatearNumero(value);
                                }
                            }
                        }
                    }
                }
            });
        }

        // Funci√≥n para actualizar tabla de analistas
        function actualizarTablaAnalistas(analistas, totalGeneral) {
            const tablaBody = document.getElementById('tablaAnalistas');
            tablaBody.innerHTML = '';
            
            analistas.forEach(analista => {
                const licitaciones = analista.licitacionesVigentes || 0;
                const tratosDirectos = analista.tratosDirectos || 0;
                const total = licitaciones + tratosDirectos;
                const porcentaje = totalGeneral > 0 ? ((total / totalGeneral) * 100).toFixed(2) : 0;
                
                const fila = document.createElement('tr');
                fila.innerHTML = `
                    <td>${analista.analista}</td>
                    <td>${licitaciones}</td>
                    <td>${tratosDirectos}</td>
                    <td>${total}</td>
                    <td>${porcentaje}%</td>
                `;
                tablaBody.appendChild(fila);
            });
        }

        // Funci√≥n para inicializar funcionalidad de b√∫squedas
        function inicializarBusquedas() {
            // B√∫squeda por Licitaci√≥n
            document.getElementById('searchFormLicitacion').addEventListener('submit', function(e) {
                e.preventDefault();
                const idLicitacion = document.getElementById('searchInputLicitacion').value.trim();
                if (idLicitacion) {
                    buscarLicitacion(idLicitacion);
                }
            });
            
            // B√∫squeda por Trato Directo
            document.getElementById('searchFormTratoDirecto').addEventListener('submit', function(e) {
                e.preventDefault();
                const idTratoDirecto = document.getElementById('searchInputTratoDirecto').value.trim();
                if (idTratoDirecto) {
                    buscarTratoDirecto(idTratoDirecto);
                }
            });
        }

        // Funci√≥n para buscar licitaci√≥n
        async function buscarLicitacion(id) {
            mostrarCargando('licitacion');
            ocultarError('licitacion');
            ocultarResultado('licitacion');
            
            try {
                const response = await fetch(`${SCRIPT_URL}?id=${encodeURIComponent(id)}&tipo=licitacion`);
                const data = await response.json();
                
                if (data.success && data.data && data.data.length > 0) {
                    mostrarResultadoLicitacion(data.data, id);
                } else {
                    mostrarError(data.error || 'No se encontraron resultados para esta licitaci√≥n', 'licitacion');
                }
            } catch (error) {
                console.error('Error buscando licitaci√≥n:', error);
                mostrarError('Error conectando con el servidor', 'licitacion');
            } finally {
                ocultarCargando('licitacion');
            }
        }

        // Funci√≥n para buscar trato directo
        async function buscarTratoDirecto(id) {
            mostrarCargando('tratoDirecto');
            ocultarError('tratoDirecto');
            ocultarResultado('tratoDirecto');
            
            try {
                const response = await fetch(`${SCRIPT_URL}?id=${encodeURIComponent(id)}&tipo=trato-directo`);
                const data = await response.json();
                
                if (data.success && data.data && data.data.length > 0) {
                    mostrarResultadoTratoDirecto(data.data, id);
                } else {
                    mostrarError(data.error || 'No se encontraron resultados para este trato directo', 'tratoDirecto');
                }
            } catch (error) {
                console.error('Error buscando trato directo:', error);
                mostrarError('Error conectando con el servidor', 'tratoDirecto');
            } finally {
                ocultarCargando('tratoDirecto');
            }
        }

        // Funci√≥n para mostrar resultado de b√∫squeda de licitaci√≥n en formato tablitas Excel
        function mostrarResultadoLicitacion(datos, id) {
            const resultSection = document.getElementById('resultSectionLicitacion');
            const resultGrid = document.getElementById('resultGridLicitacion');
            const resultId = document.getElementById('resultIdLicitacion');
            
            resultId.textContent = `ID: ${id}`;
            resultGrid.innerHTML = '';
            
            datos.forEach((registro, index) => {
                const tabla = document.createElement('table');
                tabla.className = 'excel-table';
                
                // Si hay m√∫ltiples registros, agregar encabezado de proveedor
                if (datos.length > 1) {
                    const headerRow = document.createElement('tr');
                    headerRow.className = 'header-row';
                    headerRow.innerHTML = `<td colspan="2" style="text-align: center; font-weight: bold; font-size: 1.1rem;">PROVEEDOR ${index + 1}: ${registro.proveedor || 'No especificado'}</td>`;
                    tabla.appendChild(headerRow);
                }
                
                // Agregar filas de datos
                const filas = [
                    { label: 'A√±o', value: registro.a√±o || 'N/A' },
                    { label: 'Nombre Licitaci√≥n', value: registro.nombreLicitacion || 'N/A' },
                    { label: 'Proveedor', value: registro.proveedor || 'N/A' },
                    { label: 'T√©rmino Contrato', value: registro.terminoContrato || 'N/A' },
                    { label: 'Alerta Contrato', value: typeof registro.alertaContrato === 'number' ? `${registro.alertaContrato} d√≠as` : registro.alertaContrato || 'N/A' },
                    { label: 'Monto Adjudicado', value: registro.montoAdjudicado || 'N/A' },
                    { label: 'Saldo Adjudicado', value: registro.saldoAdjudicado || 'N/A' },
                    { label: 'Observaci√≥n', value: registro.observacion || 'N/A' }
                ];
                
                filas.forEach(fila => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td style="font-weight: bold; width: 30%; background: #f8f9fa;">${fila.label}</td>
                        <td style="width: 70%;">${fila.value}</td>
                    `;
                    tabla.appendChild(tr);
                });
                
                resultGrid.appendChild(tabla);
                
                // Agregar separador entre m√∫ltiples registros
                if (index < datos.length - 1) {
                    const separador = document.createElement('div');
                    separador.style.height = '20px';
                    resultGrid.appendChild(separador);
                }
            });
            
            resultSection.classList.add('active');
        }

        // Funci√≥n para mostrar resultado de b√∫squeda de trato directo en formato tablitas Excel
        function mostrarResultadoTratoDirecto(datos, id) {
            const resultSection = document.getElementById('resultSectionTratoDirecto');
            const resultGrid = document.getElementById('resultGridTratoDirecto');
            const resultId = document.getElementById('resultIdTratoDirecto');
            
            resultId.textContent = `ID: ${id}`;
            resultGrid.innerHTML = '';
            
            datos.forEach((registro, index) => {
                const tabla = document.createElement('table');
                tabla.className = 'excel-table';
                
                // Si hay m√∫ltiples registros, agregar encabezado
                if (datos.length > 1) {
                    const headerRow = document.createElement('tr');
                    headerRow.className = 'header-row';
                    headerRow.innerHTML = `<td colspan="2" style="text-align: center; font-weight: bold; font-size: 1.1rem;">REGISTRO ${index + 1}</td>`;
                    tabla.appendChild(headerRow);
                }
                
                // Agregar filas de datos
                const filas = [
                    { label: 'A√±o', value: registro.a√±o || 'N/A' },
                    { label: 'TD', value: registro.td || 'N/A' },
                    { label: 'N√∫mero OC', value: registro.numeroOC || 'N/A' },
                    { label: 'Proveedor', value: registro.proveedor || 'N/A' },
                    { label: 'T√©rmino Contrato', value: registro.terminoContrato || 'N/A' },
                    { label: 'Alerta Contrato', value: typeof registro.alertaContrato === 'number' ? `${registro.alertaContrato} d√≠as` : registro.alertaContrato || 'N/A' },
                    { label: 'Monto Adjudicado', value: registro.montoAdjudicado || 'N/A' },
                    { label: 'Saldo', value: registro.saldo || 'N/A' },
                    { label: 'Observaci√≥n', value: registro.observacion || 'N/A' }
                ];
                
                filas.forEach(fila => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td style="font-weight: bold; width: 30%; background: #f8f9fa;">${fila.label}</td>
                        <td style="width: 70%;">${fila.value}</td>
                    `;
                    tabla.appendChild(tr);
                });
                
                resultGrid.appendChild(tabla);
                
                // Agregar separador entre m√∫ltiples registros
                if (index < datos.length - 1) {
                    const separador = document.createElement('div');
                    separador.style.height = '20px';
                    resultGrid.appendChild(separador);
                }
            });
            
            resultSection.classList.add('active');
        }

        // Funci√≥n para cargar contratos caducados
        async function cargarContratosCaducados() {
            try {
                // Cargar licitaciones caducadas
                const responseLicitaciones = await fetch(`${SCRIPT_URL}?action=getLicitacionesCaducadas`);
                const dataLicitaciones = await responseLicitaciones.json();
                
                // Cargar tratos directos caducados
                const responseTratosDirectos = await fetch(`${SCRIPT_URL}?action=getTratosDirectosCaducados`);
                const dataTratosDirectos = await responseTratosDirectos.json();
                
                if (dataLicitaciones.success) {
                    datosLicitacionesFiltro = dataLicitaciones.data || [];
                    actualizarAlertasLicitaciones(datosLicitacionesFiltro);
                    actualizarFiltrosLicitaciones(datosLicitacionesFiltro);
                }
                
                if (dataTratosDirectos.success) {
                    datosTratosDirectosFiltro = dataTratosDirectos.data || [];
                    actualizarAlertasTratosDirectos(datosTratosDirectosFiltro);
                    actualizarFiltrosTratosDirectos(datosTratosDirectosFiltro);
                }
                
            } catch (error) {
                console.error('Error cargando contratos caducados:', error);
            }
        }

        // Funci√≥n para actualizar filtros de licitaciones
        function actualizarFiltrosLicitaciones(datos) {
            const selectAnalista = document.getElementById('filtroAnalistaLicitaciones');
            const selectAno = document.getElementById('filtroAnoLicitaciones');
            
            // Limpiar opciones existentes (excepto la primera)
            while (selectAnalista.children.length > 1) selectAnalista.removeChild(selectAnalista.lastChild);
            while (selectAno.children.length > 1) selectAno.removeChild(selectAno.lastChild);
            
            // Obtener valores √∫nicos
            const analistas = [...new Set(datos.map(item => item.nombreAnalista).filter(Boolean))].sort();
            const anos = [...new Set(datos.map(item => item.a√±o).filter(Boolean))].sort((a, b) => b - a);
            
            // Agregar opciones
            analistas.forEach(analista => {
                const option = document.createElement('option');
                option.value = analista;
                option.textContent = analista;
                selectAnalista.appendChild(option);
            });
            
            anos.forEach(ano => {
                const option = document.createElement('option');
                option.value = ano;
                option.textContent = ano;
                selectAno.appendChild(option);
            });
        }

        // Funci√≥n para actualizar filtros de tratos directos
        function actualizarFiltrosTratosDirectos(datos) {
            const selectAnalista = document.getElementById('filtroAnalistaTratos');
            const selectAno = document.getElementById('filtroAnoTratos');
            
            // Limpiar opciones existentes (excepto la primera)
            while (selectAnalista.children.length > 1) selectAnalista.removeChild(selectAnalista.lastChild);
            while (selectAno.children.length > 1) selectAno.removeChild(selectAno.lastChild);
            
            // Obtener valores √∫nicos
            const analistas = [...new Set(datos.map(item => item.nombreAnalista).filter(Boolean))].sort();
            const anos = [...new Set(datos.map(item => item.a√±o).filter(Boolean))].sort((a, b) => b - a);
            
            // Agregar opciones
            analistas.forEach(analista => {
                const option = document.createElement('option');
                option.value = analista;
                option.textContent = analista;
                selectAnalista.appendChild(option);
            });
            
            anos.forEach(ano => {
                const option = document.createElement('option');
                option.value = ano;
                option.textContent = ano;
                selectAno.appendChild(option);
            });
        }

        // Funci√≥n para aplicar filtros a licitaciones
        function aplicarFiltrosLicitaciones() {
            const filtroAnalista = document.getElementById('filtroAnalistaLicitaciones').value;
            const filtroAno = document.getElementById('filtroAnoLicitaciones').value;
            const filtroProveedor = document.getElementById('filtroProveedorLicitaciones').value.toLowerCase();
            const filtroEstado = document.getElementById('filtroEstadoLicitaciones').value;
            
            let datosFiltrados = datosLicitacionesFiltro.filter(item => {
                // Filtro por analista
                if (filtroAnalista && item.nombreAnalista !== filtroAnalista) return false;
                
                // Filtro por a√±o
                if (filtroAno && item.a√±o != filtroAno) return false;
                
                // Filtro por proveedor
                if (filtroProveedor && !item.proveedor.toLowerCase().includes(filtroProveedor)) return false;
                
                // Filtro por estado
                if (filtroEstado) {
                    if (filtroEstado === 'CADUCADA' && item.alertaContrato !== 'CADUCADA') return false;
                    if (filtroEstado === 'ALERTA' && item.alertaContrato === 'CADUCADA') return false;
                }
                
                return true;
            });
            
            actualizarAlertasLicitaciones(datosFiltrados, true);
            filtrosAplicadosLicitaciones = true;
            
            // Actualizar informaci√≥n de resultados
            const infoElement = document.getElementById('infoResultadosLicitaciones');
            infoElement.textContent = `Mostrando ${datosFiltrados.length} de ${datosLicitacionesFiltro.length} resultados`;
            
            if (filtroAnalista || filtroAno || filtroProveedor || filtroEstado) {
                infoElement.style.background = 'rgba(52, 152, 219, 0.1)';
                infoElement.style.color = '#2980b9';
            } else {
                infoElement.style.background = 'var(--light-color)';
                infoElement.style.color = 'var(--dark-color)';
            }
        }

        // Funci√≥n para aplicar filtros a tratos directos
        function aplicarFiltrosTratosDirectos() {
            const filtroAnalista = document.getElementById('filtroAnalistaTratos').value;
            const filtroAno = document.getElementById('filtroAnoTratos').value;
            const filtroProveedor = document.getElementById('filtroProveedorTratos').value.toLowerCase();
            
            let datosFiltrados = datosTratosDirectosFiltro.filter(item => {
                // Filtro por analista
                if (filtroAnalista && item.nombreAnalista !== filtroAnalista) return false;
                
                // Filtro por a√±o
                if (filtroAno && item.a√±o != filtroAno) return false;
                
                // Filtro por proveedor
                if (filtroProveedor && !item.proveedor.toLowerCase().includes(filtroProveedor)) return false;
                
                return true;
            });
            
            actualizarAlertasTratosDirectos(datosFiltrados, true);
            filtrosAplicadosTratosDirectos = true;
            
            // Actualizar informaci√≥n de resultados
            const infoElement = document.getElementById('infoResultadosTratos');
            infoElement.textContent = `Mostrando ${datosFiltrados.length} de ${datosTratosDirectosFiltro.length} resultados`;
            
            if (filtroAnalista || filtroAno || filtroProveedor) {
                infoElement.style.background = 'rgba(52, 152, 219, 0.1)';
                infoElement.style.color = '#2980b9';
            } else {
                infoElement.style.background = 'var(--light-color)';
                infoElement.style.color = 'var(--dark-color)';
            }
        }

        // Funci√≥n para limpiar filtros de licitaciones
        function limpiarFiltrosLicitaciones() {
            document.getElementById('filtroAnalistaLicitaciones').value = '';
            document.getElementById('filtroAnoLicitaciones').value = '';
            document.getElementById('filtroProveedorLicitaciones').value = '';
            document.getElementById('filtroEstadoLicitaciones').value = '';
            
            actualizarAlertasLicitaciones(datosLicitacionesFiltro, false);
            filtrosAplicadosLicitaciones = false;
            
            const infoElement = document.getElementById('infoResultadosLicitaciones');
            infoElement.textContent = 'Mostrando todos los resultados';
            infoElement.style.background = 'var(--light-color)';
            infoElement.style.color = 'var(--dark-color)';
        }

        // Funci√≥n para limpiar filtros de tratos directos
        function limpiarFiltrosTratosDirectos() {
            document.getElementById('filtroAnalistaTratos').value = '';
            document.getElementById('filtroAnoTratos').value = '';
            document.getElementById('filtroProveedorTratos').value = '';
            
            actualizarAlertasTratosDirectos(datosTratosDirectosFiltro, false);
            filtrosAplicadosTratosDirectos = false;
            
            const infoElement = document.getElementById('infoResultadosTratos');
            infoElement.textContent = 'Mostrando todos los resultados';
            infoElement.style.background = 'var(--light-color)';
            infoElement.style.color = 'var(--dark-color)';
        }

        // Funci√≥n para actualizar alertas de licitaciones
        function actualizarAlertasLicitaciones(licitaciones, conFiltros = false) {
            const tablaBody = document.getElementById('tablaAlertasLicitaciones');
            tablaBody.innerHTML = '';
            
            let contadorCaducadas = 0;
            let contadorAlerta = 0;
            
            if (!licitaciones || licitaciones.length === 0) {
                const fila = document.createElement('tr');
                fila.innerHTML = `<td colspan="9" style="text-align: center; padding: 20px;">No se encontraron licitaciones con los filtros aplicados</td>`;
                tablaBody.appendChild(fila);
                
                // Actualizar contadores a 0 cuando no hay resultados
                document.getElementById('contadorLicitacionesCaducadas').textContent = '0';
                document.getElementById('contadorLicitacionesAlerta').textContent = '0';
                return;
            }
            
            licitaciones.forEach(licitacion => {
                const fila = document.createElement('tr');
                
                // Determinar clase de alerta
                let claseAlerta = '';
                if (licitacion.alertaContrato === 'CADUCADA') {
                    claseAlerta = 'alerta-caducada';
                    contadorCaducadas++;
                } else if (licitacion.alertaContrato !== undefined && licitacion.alertaContrato < 121) {
                    claseAlerta = 'alerta-baja';
                    contadorAlerta++;
                }
                
                fila.className = claseAlerta;
                
                fila.innerHTML = `
                    <td>${licitacion.a√±o || ''}</td>
                    <td>${licitacion.proveedor || ''}</td>
                    <td><strong>${licitacion.alertaContrato || ''}</strong></td>
                    <td>${licitacion.montoAdjudicado || ''}</td>
                    <td>${licitacion.saldoAdjudicado || ''}</td>
                    <td>${licitacion.idLicitacion || ''}</td>
                    <td>${licitacion.nombreLicitacion || ''}</td>
                    <td>${licitacion.nombreAnalista || ''}</td>
                    <td>${licitacion.observacion || ''}</td>
                `;
                
                tablaBody.appendChild(fila);
            });
            
            // Actualizar contadores (siempre, incluso con filtros)
            document.getElementById('contadorLicitacionesCaducadas').textContent = contadorCaducadas;
            document.getElementById('contadorLicitacionesAlerta').textContent = contadorAlerta;
        }

        // Funci√≥n para actualizar alertas de tratos directos
        function actualizarAlertasTratosDirectos(tratosDirectos, conFiltros = false) {
            const tablaBody = document.getElementById('tablaAlertasTratosDirectos');
            tablaBody.innerHTML = '';
            
            let contadorCaducados = 0;
            let contadorAlerta = 0;
            
            if (!tratosDirectos || tratosDirectos.length === 0) {
                const fila = document.createElement('tr');
                fila.innerHTML = `<td colspan="10" style="text-align: center; padding: 20px;">No se encontraron tratos directos con los filtros aplicados</td>`;
                tablaBody.appendChild(fila);
                
                // Actualizar contadores a 0 cuando no hay resultados
                document.getElementById('contadorTratosCaducados').textContent = '0';
                document.getElementById('contadorTratosAlerta').textContent = '0';
                return;
            }
            
            tratosDirectos.forEach(trato => {
                const fila = document.createElement('tr');
                
                // Determinar clase de alerta
                let claseAlerta = '';
                if (trato.alertaContrato === 'CADUCADA') {
                    claseAlerta = 'alerta-caducada';
                    contadorCaducados++;
                } else if (trato.alertaContrato !== undefined && trato.alertaContrato < 121) {
                    claseAlerta = 'alerta-baja';
                    contadorAlerta++;
                }
                
                fila.className = claseAlerta;
                
                fila.innerHTML = `
                    <td>${trato.a√±o || ''}</td>
                    <td>${trato.numeroOC || ''}</td>
                    <td>${trato.proveedor || ''}</td>
                    <td>${trato.terminoContrato || ''}</td>
                    <td><strong>${trato.alertaContrato || ''}</strong></td>
                    <td>${trato.montoAdjudicado || ''}</td>
                    <td>${trato.saldo || ''}</td>
                    <td>${trato.td || ''}</td>
                    <td>${trato.nombreAnalista || ''}</td>
                    <td>${trato.observacion || ''}</td>
                `;
                
                tablaBody.appendChild(fila);
            });
            
            // Actualizar contadores (siempre, incluso con filtros)
            document.getElementById('contadorTratosCaducados').textContent = contadorCaducados;
            document.getElementById('contadorTratosAlerta').textContent = contadorAlerta;
        }

        // FUNCIONES UTILITARIAS

        // Funci√≥n para formatear n√∫meros grandes
        function formatearNumero(numero) {
            return numero.toLocaleString('es-CL');
        }

        // Funciones auxiliares para mostrar/ocultar elementos
        function mostrarCargando(tipo) {
            document.getElementById(`loadingIndicator${capitalizeFirstLetter(tipo)}`).style.display = 'block';
        }
        
        function ocultarCargando(tipo) {
            document.getElementById(`loadingIndicator${capitalizeFirstLetter(tipo)}`).style.display = 'none';
        }
        
        function mostrarError(mensaje, tipo) {
            const errorAlert = document.getElementById(`errorAlert${capitalizeFirstLetter(tipo)}`);
            const errorMessage = document.getElementById(`errorMessage${capitalizeFirstLetter(tipo)}`);
            
            errorMessage.textContent = mensaje;
            errorAlert.style.display = 'block';
        }
        
        function ocultarError(tipo) {
            document.getElementById(`errorAlert${capitalizeFirstLetter(tipo)}`).style.display = 'none';
        }
        
        function ocultarResultado(tipo) {
            document.getElementById(`resultSection${capitalizeFirstLetter(tipo)}`).classList.remove('active');
        }

        // Funci√≥n para capitalizar primera letra
        function capitalizeFirstLetter(string) {
            return string.charAt(0).toUpperCase() + string.slice(1);
        }
    </script>
</body>
</html>